<!doctype html>
<html>
 <head> 
  <meta content="text/html; charset=UTF-8" http-equiv="content-type"> 
  <title>Sử dụng PHP với Docker</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="icon" href="../../images/favicon.png"> 
  <link rel="stylesheet" href="../../css/style.css"> 
  <meta name="description" content="Sử dụng PHP với Docker">
 </head> 
 <body> 
  <article> 
   <p>https://viblo.asia/p/docker-compose-xay-dung-moi-truong-phat-trien-ung-dung-web-php-mysql-MLzGObNovpq</p> 
   <h1>Docker Compose: Xây dựng môi trường phát triển ứng dụng web - PHP, MySql</h1> 
   <p><img src="https://viblo.asia/uploads/8b53f5f8-d41b-43c5-9a7c-8f846a03122a.png"></p> 
   <p>Chào mọi người!</p> 
   <p>Hôm nay sẽ tiếp tục loạt bài "Mình biết thì mình chia sẻ" của mình mong tiếp tục nhận được sự ủng hộ từ anh em.</p> 
   <p>Rất xin lỗi vì sau bài viết trước <a href="https://viblo.asia/telosma/posts/PDOkqLAKejx" target="_blank">Docker với lập trình viên web</a> của mình thì mình lại ngắt quãng không thể đi luôn vào phần tìm hiểu tiếp tục kết nối với cơ sở dữ liệu. Hôm nay chúng ta sẽ cùng đi giải quyết vấn đề đó.</p> 
   <h2>Bài toán</h2> 
   <ul> 
    <li> <p>Mình có một project php tên là selfproject xây dựng dựa trên laravel framework. Project này làm việc với hệ quản trị CSDL là MySql.</p> </li> 
    <li> <p>Vấn đề là bây giờ mình muốn chạy nó với docker! `</p> </li> 
   </ul> 
   <h2>Giải quyết</h2> 
   <h3>Cách 1</h3> 
   <ul> 
    <li> <p>Theo như bài tìm hiểu lần trước mình sẽ sử dụng các images đã được chia sẻ bởi các lập trình viên khác trên dockerhub.</p> </li> 
    <li> <p>Mình sẽ sử dụng 2 image đó là <a href="https://hub.docker.com/r/tutum/apache-php/" target="_blank">tutum/apache-php</a> cho service apache-php và <a href="https://hub.docker.com/_/mysql/" target="_blank">mysql</a> cho mysql server.</p> </li> 
    <li> <p>Đầu tiên mình cần tạo MySQL container trước</p> <pre><code>  docker run -p 3307:3306 --name mysqlserver -e MYSQL_ROOT_PASSWORD=root -d mysql
</code></pre></li> 
   </ul> 
   <p><img src="https://viblo.asia/uploads/e04147fd-8d04-41a3-9d82-ea2dd1aaaf87.png"></p> 
   <ul> 
    <li> <p>Sau đó tạo web server container</p> <pre><code>  docker run -tid -p 9000:80 -v ~/www/sites/FrProject/Github/selfproject:/var/www/html --name selfproject-server --link mysqlserver:mysql  tutum/apache-php
</code></pre></li> 
   </ul> 
   <p><img src="https://viblo.asia/uploads/7ed0ca30-fa59-4115-852b-7ddc855ec1f4.png"></p> 
   <ul> 
    <li> <p>Ở đây mình cần mở rộng hơn trong bài tìm hiểu lần trước, đó là mình có 2 container là <code>mysqlserver</code> và <code>selfproject-server</code>, để chúng có thể giao tiếp với nhau cần link web server với mysql thông qua tùy chọn <code>--link &lt;container name or ID&gt;:&lt;alias&gt;</code></p> </li> 
    <li> <p>Bây giờ mở trình duyệt và thử kết quả</p> </li> 
   </ul> 
   <p><img src="https://viblo.asia/uploads/aeb44bd3-ea26-4b80-b7d2-55fc588d7c50.png"></p> 
   <blockquote> 
    <p>Lý do?</p> 
    <blockquote> 
     <p>Mình quên config lại trong file .env</p> 
    </blockquote> 
   </blockquote> 
   <pre><code>    DB_CONNECTION=mysql

    # host bên ngoài local

    # DB_HOST=127.0.0.1

    # Sửa trong container nên sẽ config lại

    DB_HOST=mysql
    DB_PORT=3306
    DB_DATABASE=selfproject
    DB_USERNAME=root
    DB_PASSWORD=root
</code></pre> 
   <ul> 
    <li>Kết nối tới database trong container tạo db có tên <code>selfproject</code>. Ở command tạo MYSQL container mình cần expose port ra bên ngoài container là 3307. Do ở máy mình cổng 3306 đã được sử dụng cho ứng dụng khác.</li> 
   </ul> 
   <p><img src="https://viblo.asia/uploads/ef8933b4-6f57-4df7-af58-9fbe2a61f6ad.png"></p> 
   <ul> 
    <li> <p>Ở đây mình sử dụng công cụ trực quan mysql-workbench để thao tác với mysql, các bạn có thể dụng công cụ khác như php-myadmin...</p> </li> 
    <li> <p>Giờ vào vào trong container để <code>migrate</code> dữ liệu</p> <pre><code>  docker exec -it containerName/containerId bash

  # Với mình

  docker exec -it selfproject-server bash
</code></pre></li> 
    <li> <p>Và giờ là kết quả</p> </li> 
   </ul> 
   <p><img src="https://viblo.asia/uploads/4a994470-52e5-4bea-a00f-11332e27e9bb.png"></p> 
   <ul> 
    <li>Nhưng khi muốn vào đăng ký mình gặp phải</li> 
   </ul> 
   <p><img src="https://viblo.asia/uploads/ffc3a554-815a-4f42-8fcc-6f96eb867baf.png"></p> 
   <blockquote> 
    <p>Vấn đề: không thể truy cập được url nào khác ngoài public. Khắc phục: trong container mình cần sửa lại file apache.conf đoạn <code>AllowOverride None</code> thành <code>AllowOverride ALL</code> trong <code>&lt;Directory /var/www/&gt;</code></p> 
    <blockquote> 
     <ul> 
      <li>Vào trong container</li> 
     </ul> 
    </blockquote> 
   </blockquote> 
   <pre><code>    docker exec -it containerName/caintainerId bash
</code></pre> 
   <blockquote> 
    <blockquote> 
     <ul> 
      <li>Sử dụng vim để sửa lại file apache.conf (Do container mình đang dùng không có nano =)) )</li> 
     </ul> 
    </blockquote> 
   </blockquote> 
   <pre><code>    vi /etc/apache2/apache2.conf

        **Sửa như sau**

    &lt;Directory /var/www/&gt;
    Options Indexes FollowSymLinks
    AllowOverride ALL
    Require all granted
    &lt;/Directory&gt;
</code></pre> 
   <blockquote> 
    <blockquote> 
     <ul> 
      <li>Save lại và restart service apache bên trong container.</li> 
     </ul> 
    </blockquote> 
   </blockquote> 
   <pre><code>           service apache2 restart
</code></pre> 
   <blockquote> 
    <blockquote> 
     <ul> 
      <li>Lúc này thì web server container này của mình sẽ bị terminate (ngắt kết nối) và mình cần start nó lại</li> 
     </ul> 
    </blockquote> 
   </blockquote> 
   <p>Bên ngoài máy chủ của mình</p> 
   <pre><code>docker start containerName/containerId
</code></pre> 
   <p>Với mình</p> 
   <pre><code> docker start selfproject-server
</code></pre> 
   <blockquote> 
    <p>Kết quả thu được</p> 
   </blockquote> 
   <p><img src="https://viblo.asia/uploads/e04edf1b-d6cf-4805-a99d-674d53c4a506.png"></p> 
   <blockquote> 
    <blockquote> 
     <p>Ngon chạy rồi (hehe). Thử tương tác với db coi sao. Mình thử tạo một bài post và đây là kết quả</p> 
    </blockquote> 
   </blockquote> 
   <p><img src="https://viblo.asia/uploads/b80b38aa-bdef-48ae-9b07-f916ab579c7d.png"></p> 
   <blockquote> 
    <p>Các bạn thử stop cả mysqlserver với web server đi rối start lại xem còn chạy và dữ liệu ok không nhé. Với mình thì tuyệt vời!</p> 
   </blockquote> 
   <h3><code>Một số câu hỏi và vấn đề mà mình gặp khi mới bắt đầu</code></h3> 
   <ul> 
    <li> <p>Vậy dữ liệu hắn lưu ở đâu?</p> <pre><code>       Vào trong mysql container nhé và trong /var/lib/mysql/
</code></pre></li> 
    <li> <p>Nên cẩn thận khi xóa container này nhé. Mình có thể khắc phục được vấn đề này là cũng <code>mount</code> /var/lib/mysql trong container ra một folder nào đó ngoài máy chủ của mình chẳng hạn "mysql-data" do mình tự tạo giống như mình mount folder project (nhớ nên để folder quyền user nhé, tránh để root) làm việc vào trong /var/www/html khi create web server container vậy!</p> </li> 
    <li> <p>Stop tất cả các container đang chạy</p> <pre><code>      docker stop $(docker ps -a -q)
</code></pre></li> 
    <li> <p>Khi mình chỉnh sửa, làm việc với project thì sẽ gặp phải vấn đề permission do khi <code>mount</code> vào trong container thì nó sửa toàn bộ dữ liệu trong folder của mình về owner và group là www-data, chứ không còn là current user của mình hoặc root nữa. Vậy nên mình vào trong container và cấp quyền ghi cho project của mình với user là guest.</p> <pre><code>  # Vào trong container web server
  # Đi đến folder project mà bạn đã mount

      chmod 777 -R .
   
  # Quyền các bạn tùy chọn nói chung là dạng --7 để thằng user không phải owner có thể ghi
</code></pre></li> 
    <li> <p>Với laravel 5.3 mình không thể chạy <code>php artisan</code> trong container mặc dù bên ngoài vẫn ok</p> </li> 
   </ul> 
   <blockquote> 
    <ul> 
     <li>Lý do: laravel 5.3 yêu cầu version của php &gt; 5.6 trong khi image mình đang dùng là tutum/apache-php với version php 5.5.9. Khá đau đầu với ông này mình mới nhìn ra được =))</li> 
     <li>Khắc phục: Tự build image hoặc sử dụng image khác có sẵn mà phiên bản &gt; 5.6. Với mình chọn sử dụng image được chia sẻ bởi cộng đồng docker-hub. Thay vì dùng tutum/apache-php thì dùng webdevops/php-apache (Ông này cũng có vấn đề với bản laravel 5.4 nên nếu có lỗi bạn có thể thử với nimmis/apache-php7 hoặc bất cứ ông nào mà bạn tìm thấy trên docker hub và cảm thấy phù hợp với project của mình)</li> 
    </ul> 
   </blockquote> 
   <h3>Cách 2</h3> 
   <h4><code>Take it easy</code> với Docker compose</h4> 
   <ul> 
    <li> <p>Chẳng lẽ mỗi lần code lại start từng con server một, nếu có 3 hay nhiều hơn nữa thì mệt quá, phải nhớ container name vì id là bất khả thi rồi =)). Rồi lại cần nhớ thứ tự start nữa.</p> 
     <ul> 
      <li>Như việc link Mysql với Apache thì cần start server MySql trước sau đó start Apache container</li> 
     </ul> </li> 
    <li> <p>Điều đó dẫn đến việc mình bắt đầu thử sử dụng Docker compose</p> </li> 
   </ul> 
   <h4>What is Docker composer</h4> 
   <ul> 
    <li> <p>Docker compose là một công cụ cho việc định nghĩa và khởi chạy nhiều container với docker. Với compose mình sẽ khai báo nhiều container trong cùng một file và chỉ việc chạy một dòng lệnh là nó sẽ làm mọi việc start container cho mình.</p> </li> 
    <li> <p>Bạn có thể tham khảo tại <a href="https://docs.docker.com/compose/" target="_blank">đây</a></p> </li> 
   </ul> 
   <h4>Sử dụng docker compose cho ứng dụng của mình</h4> 
   <ul> 
    <li> <p>Cài đặt docker-compose thì các bạn cài đặt theo hướng dẫn tại <a href="https://docs.docker.com/compose/install/" target="_blank">trang chủ</a> docker nhé.</p> </li> 
    <li> <p>Tạo docker compose file với tên <code>docker-compose.yml</code></p> </li> 
    <li> <p>Khai báo mysql server và web server trong compose file này</p> <pre><code>  # docker-compose.yml

  version: "2"

  services:

      selfproject:
          image: tutum/apache-php
          links:
              - mysql
          ports:
              - "8888:80"
          networks:
              - back-tier
          volumes:
              - .:/var/www/html/selproject
          environment:
              - ALLOW_OVERRIDE=true
          hostname: selfproject
          cpu_shares: 512             # 0.5 CPU
          mem_limit: 536870912        # 512 MB RAM

      mysql:
          image: mysql
          ports:
              - "3307:3306"
          networks:
              - back-tier
          volumes:
              - ./mysql-data/:/var/lib/mysql/
          environment:
              - MYSQL_ROOT_PASSWORD=root
              - MYSQL_DATABASE=selfproject
          hostname: mysql
          cpu_shares: 512             # 0.5 CPU
          mem_limit: 536870912        # 512 MB RAM

  networks:
      back-tier:
</code></pre></li> 
    <li> <p>Về các options trong compose file mình sẽ không nói nhiều vì nó được mô tả khá chi tiết tại <a href="https://docs.docker.com/compose/compose-file/" target="_blank">Composefile reference</a> trên trang chủ của docker</p> </li> 
    <li> <p>Giải thích chút về nội dung file compose của mình</p> 
     <ul> 
      <li>Trước tiên là về version sử dụng đối với docker file là version '2'. Bạn có thể tìm hiểu thêm trên trang chủ docker. Version '1' là 'legacy format', version hiện tại là '2.1' và '2' là version được khuyến khích sử dụng có một số thay đổi về options so với version '1'.</li> 
      <li>Với service mysql: 
       <ul> 
        <li>image sử dụng là mysql</li> 
        <li>ports ở đây như mình đã nói với phần sử dụng command. 3306 là port được sử dụng bên trong container, 3307 được export ra bên ngoài để mình có thể xem và thao tác với dữ liệu.</li> 
        <li>networks sử dụng là back-tier</li> 
        <li>volumes ở đây chính là mount folder bên ngoài với bên trong container như phần sử dụng command. './mysql-data' là folder mình muốn lưu trữ dữ liệu ở bên ngoài, bạn có thể link bất kỳ tới đâu bạn muốn.</li> 
        <li>hostname: mysql</li> 
       </ul> </li> 
      <li>Với web service 
       <ul> 
        <li>image mình sử dụ là tutum/apache-php. Lưu ý là với laravel 5.2 trở về trước nhé, hay là với project mình không yêu cầu version php &gt; 5.6</li> 
        <li>links tới mysql container</li> 
        <li>networks: cũng phải sử dụng là back-tier cùng với mysql cho toàn bộ service trong compose file để các container có thể giao tiếp với nhau</li> 
        <li>volumes: Do docker-compose.yml file này của mình đặt ngày trong folder selfproject của mình nên đường dẫn đến project bên ngoài máy chủ là "." thư mục hiện tại và mount vào "/var/www/html/selproject" trong container</li> 
        <li> <pre><code>environment:
  - ALLOW_OVERRIDE=true
</code></pre></li> 
        <li>Như vấn đề với Override mà mình đã nói bên trên và đoạn config này giải quyết vấn đề đó.</li> 
       </ul> </li> 
     </ul> </li> 
    <li> <p>OK việc cần làm là start nó</p> <pre><code>  # Đi đến thư mục chứa compose file

      docker-compose up

  # Khi làm việc xong

      docker-compose down
</code></pre></li> 
    <li> <p>Nhớ lưu ý tới việc quyền hạn và config nhá</p> </li> 
   </ul> 
   <h2>Kết luận</h2> 
   <ul> 
    <li> <p>Cảm ơn các bạn đã dành thời gian đọc bài viết của mình. Thời gian mình tìm hiểu về docker chưa được nhiều nên có thể có nhiều sai xót, rất mong nhận được sự góp ý từ mọi người để sửa đổi nội dung bài viết được tốt hơn.</p> </li> 
    <li> <p>Hiện tại trong tài liệu chính thức của docker compose không khuyến nghị sử dụng cho production, chỉ nên sử dụng ở môi trường development, staging, continous integration</p> </li> 
   </ul> 
   <p></p> 
   <p><br> </p> 
   <p><br> </p> 
   <p></p> 
  </article> 
  <script src="../../js/docs.js"></script>  
 </body>
</html>