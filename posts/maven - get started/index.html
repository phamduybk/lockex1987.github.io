<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cài đặt và sử dụng Maven">
    <title>Bắt đầu với Maven</title>
        <link rel="icon" href="../../images/favicon.png"/>
    <link rel="stylesheet" href="../../css/style.css"/>
    <link rel="stylesheet" href="../../lib/highlightjs/css/androidstudio.css">
    <script src="../../lib/highlightjs/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <article>
      <h1>Bắt đầu với Maven</h1>
      <h2>Bắt đầu</h2>
      <p>Maven thay cho cách quản lý các thư viện jar bằng tay. Có nhiều dự án
        gần 70 file jar mà chả biết file nào để làm gì.</p>
      <h3>Download</h3>
      <p>Download file ZIP ở địa chỉ sau:</p>
      <p><a href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a></p>
      <h3>Cài đặt</h3>
      <p>Việc cài đặt Maven đơn giản chỉ là giải nén file ZIP và add thư mục bin
        vào trong biến môi trường PATH.</p>
      <p>Xác nhận kết quả của việc cài đặt với lệnh:</p>
      <p><code>mvn -v</code></p>
      <p>Kết quả mẫu là:</p>
      <p><code>Apache Maven 3.3.9 (bb52d8502b132ec0a5a3f4c09453c07478323dc5;
          2015-11-10T23:41:47+07:00)<br>
          Maven home: /data/program/maven<br>
          Java version: 1.8.0_60, vendor: Oracle Corporation<br>
          Java home: /usr/local/java/jre<br>
          Default locale: en_US, platform encoding: UTF-8<br>
          OS name: "linux", version: "3.16.0-38-generic", arch: "i386", family:
          "unix"</code></p>
      <h3>Cấu hình</h3>
      <p>Có một số cách để cấu hình Maven. Tuy nhiên cách thông thường nhất đó
        là sửa file settings.xml ở thư mục USER_HOME/.m2, hoặc sửa file
        settings.xml ở thư mục MAVEN_HOME/conf.</p>
      <p>Ví dụ:</p>
      <pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"&gt;
          
	&lt;localRepository&gt;/data/program/maven/repository&lt;/localRepository&gt;

	&lt;pluginGroups&gt;&lt;/pluginGroups&gt;
	&lt;proxies&gt;&lt;/proxies&gt;
	&lt;servers&gt;&lt;/servers&gt;
	&lt;mirrors&gt;&lt;/mirrors&gt;
	
	&lt;profiles&gt;
		&lt;profile&gt;
			&lt;id&gt;downloadSources&lt;/id&gt;
			&lt;properties&gt;
				&lt;downloadSources&gt;true&lt;/downloadSources&gt;
				&lt;downloadJavadocs&gt;true&lt;/downloadJavadocs&gt;
			&lt;/properties&gt;
		&lt;/profile&gt;
	&lt;/profiles&gt;

	&lt;activeProfiles&gt;
		&lt;activeProfile&gt;downloadSources&lt;/activeProfile&gt;
	&lt;/activeProfiles&gt;
&lt;/settings&gt;</code>
</pre>
      <p>Trong ví dụ trên, chúng ta có cấu hình lại thư mục repository trên
        local. Chúng ta nên lưu nó ở thư mục dữ liệu (ổ D), không nên lưu ở thư
        mục cài đặt (ổ C) để mỗi lần cài lại hệ điều hành thì không bị mất.</p>
      <pre><code class="xml">&lt;localRepository&gt;/data/program/maven/repository&lt;/localRepository&gt;</code></pre>
      <h3>Tích hợp IDE<br>
      </h3>
      <p>Chúng ta hãy thử tích hợp Maven với Eclipse.</p>
      <p>Chọn menu <code>Window -&gt; Preferences -&gt; Maven -&gt; User
          Settings</code>, ở mục Global Settings chọn lại đúng file. Mục Local
        Repository sẽ tự động được điều chỉnh.</p>
      <img alt="Maven Eclipse settings" src="images/maven-eclipse-settings.png">:
      <p> </p>
      <h3>Cấu trúc thư mục chuẩn</h3>
      <table>
        <tbody>
          <tr>
            <td>src/main/java</td>
            <td>Java code</td>
          </tr>
          <tr>
            <td>src/main/resources</td>
            <td>Các file cấu hình</td>
          </tr>
          <tr>
            <td>src/main/webapp</td>
            <td>Thư mục web</td>
          </tr>
          <tr>
            <td>src/test/java</td>
            <td>Unit Test source</td>
          </tr>
          <tr>
            <td>src/test/resources</td>
            <td>Test resource</td>
          </tr>
          <tr>
            <td>pom.xml</td>
            <td>Project Object Model</td>
          </tr>
        </tbody>
      </table>
      <p>Ở ngoài cùng là file pom.xml và thư mục src. Ngoài ra có thể có file
        LICENSE.txt, README.md.</p>
      <h3>File pom.xml</h3>
      <p>File pom.xml là một file rất quan trọng.</p>
      <p>Một file pom.xml mẫu đặc trưng là:</p>
      <pre><code class="xml">&lt;project
	xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
	&lt;groupId&gt;cttd&lt;/groupId&gt;
	&lt;artifactId&gt;&lt;/artifactId&gt;
	&lt;version&gt;1.0.0&lt;/version&gt;

	&lt;properties&gt;
		&lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
		&lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
	&lt;/properties&gt;


	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;junit&lt;/groupId&gt;
			&lt;artifactId&gt;junit&lt;/artifactId&gt;
			&lt;version&gt;4.12&lt;/version&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;
&lt;/project&gt;</code></pre>
      <p>Trong file pom trên chúng ta sẽ có luôn các cấu hình là phiên bản Java,
        source encoding UTF-8, jUnit.</p>
      <p>Để chỉ định phiên bản Java, nếu sử dụng Spring Boot thì chỉ cấu hình:</p>
      <pre><code class="xml">&lt;properties&gt;
    &lt;java.version&gt;1.7&lt;/java.version&gt;
&lt;/properties&gt;</code></pre>
      <h3>Cấu hình proxy cho Maven</h3>
      <p>Ở máy cơ quan chẳng hạn, nhiều khi bạn không thể truy cập Internet trực
        tiếp mà phải qua proxy. Để thiết lập proxy cho Maven, hãy sửa file
        settings.xml như sau:</p>
      <pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
						http://maven.apache.org/xsd/settings-1.0.0.xsd"&gt;
	&lt;proxies&gt;
		&lt;proxy&gt;
			&lt;active&gt;true&lt;/active&gt;
			&lt;protocol&gt;https&lt;/protocol&gt;
			&lt;host&gt;10.225.1.1&lt;/host&gt;
			&lt;port&gt;3128&lt;/port&gt;        
			&lt;username&gt;&lt;/username&gt;
			&lt;password&gt;&lt;/password&gt;    
		&lt;/proxy&gt;
	&lt;/proxies&gt;
&lt;/settings&gt;</code>
</pre>
      <h3>Maven command line</h3>
      <h3> </h3>
      <p><strong>mvn compile</strong><br>
        <br>
        Lần đầu tiên thực thi command này, maven sẽ download toàn bộ các pluin
        và các dependency liên quan. Nếu bạn thực thi lại lệnh này, maven sẽ
        không download lại những gì nó đã có từ lần trước, vậy nên command sẽ
        được thực thi nhanh hơn. Các class được compile sẽ được đưa vào
        ${basedir}/target/classes<br>
      </p>
      <p><strong>mvn test</strong><br>
        <br>
        Bạn có một số unit tests và bạn muốn compile và thực thi chúng, bạn chỉ
        cần sử dụng command trên.</p>
      <p><strong>mvn test-compile</strong><br>
        <br>
        Nếu bạn chỉ muốn complie test sources mà không muốn thực thi, bạn sử
        dụng command trên.</p>
      <p><strong>mvn -Dtest=&lt;class&gt; test</strong></p>
      <p>Để chạy test 1 file test nào đó. Ví dụ:</p>
      <p><code>mvn -Dtest=TestApp1 test</code></p>
      <p><code>mvn -Dtest=TestApp2 test</code></p>
      <p><strong>mvn package</strong><br>
        <br>
        Bạn muốn xuất project của mình ra file jar để sử dụng. Bạn xem lại file
        pom.xml, phần tử packaging phải có giá trị là jar (nếu là war thì maven
        sẽ xuất ra file war). Sau đó, bạn sử dụng command trên.</p>
      <p>Nếu bạn muốn bỏ qua test thì dùng lệnh:</p>
      <p><code>mvn package -Dmaven.test.skip=true</code></p>
      <p><strong>mvn install</strong><br>
        <br>
        Command mvn package chỉ mới xuất ra file jar vào thư mục
        ${basedir}/target, để có thể đưa file jar vào trong local repository
        thực thi thêm command</p>
      <p><strong>mvn clean</strong><br>
        <br>
        Thư mục target sẽ bị xóa cùng với các dữ liệu trong đó trước khi project
        được làm mới</p>
      <p><strong>mvn clean install</strong><br>
        <br>
        Khi muốn build project thành các file chạy .jar hoặc .war, người ta
        thường sử dụng đồng thời cả lệnh mvn clean và install.</p>
      <p><strong>mvn site</strong><br>
        <br>
        Tạo 1 document site cho project, hiển thị các thông tin liên quan đến
        project (ví dụ như các dependency, các plugin được sử dụng – khai báo
        trong pom)<br>
        <br>
        <strong>mvn eclipse:eclipse</strong><br>
        <br>
        Nếu bạn sử dụng eclipse, lệnh này sẽ giúp project có thể dễ dàng import
        và sử dụng trên eclipse </p>
      <p><strong>mvn install</strong></p>
      <p>Nhiều khi file jar của không có trên Maven repository, hoặc là bạn tạo
        ra một file jar và muốn sử dụng cho dự án khác. Để cài đặt file jar<code><strong>.<br>
          </strong></code></p>
      <code> </code>
      <p><code>mvn install:install-file
          -Dfile=QueryCrypt.jar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          -DgroupId=guhesan -DartifactId=querycrypt -Dversion=1.0
          -Dpackaging=jar -DgeneratePom=true </code></p>
      <code> </code>
      <p><code>mvn install:install-file -Dfile=target/cttd-core-1.0.jar
          -DgroupId=cttd&nbsp;&nbsp;&nbsp; -DartifactId=cttd-core&nbsp;
          -Dversion=1.0 -Dpackaging=jar -DgeneratePom=true</code></p>
      <h3>Lỗi khi sử dụng plugin maven-jar-plugin trong Eclipse</h3>
      <p>Để đóng gói file jar với Maven, tôi sử dụng plugin maven-jar-plugin
        phiên bản 3.0.2.</p>
      <p>Khi sử dụng trên Eclipse Neon 4.6.0, file pom.xml bị báo đỏ với thông
        báo:</p>
      <p><code>org.codehaus.plexus.archiver.jar.Manifest.write(java.io.PrintWriter)</code></p>
      <p>Tôi vẫn có thể package file jar cũng như làm các thứ khác bình thường,
        tuy nhiên thông báo lỗi kia thật annoying.</p>
      <p>Sau khi search Google thì cách giải quyết là hãy cài đặt
        m2eclipse-mavenarchiver (0.17.2) phiên bản mới nhất cho Eclipse.</p>
      <p>Cách cài đặt:</p>
      <p>Go to Help -&gt; Install new softwares -&gt; Add repository</p>
      <p>https://otto.takari.io/content/sites/m2e.extras/m2eclipse-mavenarchiver/0.17.2/N/LATEST/</p>
      <p>Restart Eclipse and update project.</p>
      <p>Hy vọng Eclipse sẽ tự giải quyết vấn đề này.</p>
      <h3>Packaging</h3>
      <p> Chúng ta sẽ sử dụng Maven để compile project và output thành 1 file
        jar.</p>
      <p>Trong file pom.xml, nếu packaging là jar, nó sẽ đóng gói project thành
        file jar và đặt trong thưc mục target. Nếu packaging là war, nó sẽ đóng
        gói project thành file war và đặt trong thư mục target.</p>
      <p><strong>Cách 1: Tạo 1 file jar bình thường</strong></p>
      <p>Bạn không phải cấu hình thêm gì. Build bằng câu lệnh:</p>
      <p>mvn clean package -Dmaven.test.skip=true</p>
      <p>Khi chạy phải chỉ định classpath. Để thực thi file, thực hiện lệnh:</p>
      <p><code>java -cp target/build-jar.jar cttd.maven.HelloWorld</code></p>
      <p>Nếu có dependency thì chúng ta cần trỏ classpath đến cả dependency đó:<code><br>
        </code></p>
      <p><code>java -cp target/build-jar.jar:target/joda-time-2.9.6.jar
          cttd.maven.Main</code></p>
      <p><strong>Cách 2: Tạo 1 file jar và ánh xạ đến các dependency (Các
          dependency trong thư mục lib)</strong></p>
      <p>Thêm vào file pom 2 cấu hình sau:</p>
      <pre><code class="xml">&lt;!-- Make this jar executable --&gt;
&lt;plugin&gt;
	&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
	&lt;version&gt;3.0.2&lt;/version&gt;
	&lt;configuration&gt;
		&lt;!-- DO NOT include config.properties file in your Jar --&gt;
		&lt;excludes&gt;
			&lt;exclude&gt;**/config.properties&lt;/exclude&gt;
		&lt;/excludes&gt;
		&lt;archive&gt;
			&lt;!-- Ignore files pom.xml, pom.properties in the jar file --&gt;
			&lt;addMavenDescriptor&gt;false&lt;/addMavenDescriptor&gt;
			&lt;manifest&gt;
				&lt;!-- Jar file entry point --&gt;
				&lt;mainClass&gt;cttd.maven.Main&lt;/mainClass&gt;
				&lt;addClasspath&gt;true&lt;/addClasspath&gt;
				&lt;classpathPrefix&gt;lib/&lt;/classpathPrefix&gt;
			&lt;/manifest&gt;
		&lt;/archive&gt;
	&lt;/configuration&gt;
&lt;/plugin&gt;

&lt;!-- Copy project dependency --&gt;
&lt;plugin&gt;
	&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
	&lt;version&gt;2.10&lt;/version&gt;
	&lt;executions&gt;
		&lt;execution&gt;
			&lt;id&gt;copy-dependencies&lt;/id&gt;
			&lt;phase&gt;package&lt;/phase&gt;
			&lt;goals&gt;
				&lt;goal&gt;copy-dependencies&lt;/goal&gt;
			&lt;/goals&gt;
			&lt;configuration&gt;
				&lt;!-- exclude junit, we need runtime dependency only --&gt;
				&lt;includeScope&gt;runtime&lt;/includeScope&gt;
				&lt;outputDirectory&gt;${project.build.directory}/lib/&lt;/outputDirectory&gt;
			&lt;/configuration&gt;
		&lt;/execution&gt;
	&lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
      <p>Khi chạy thì dùng lệnh:</p>
      <p><code>java -jar &lt;File jar đặc biệt&gt;</code></p>
      <p><code>java -jar target/build-jar.jar</code></p>
      <p>Các cấu hình thì để thư mục nào? conf?</p>
      <p>Bạn có thể xem file MANIFEST.MF trong thư mục META-INF của file jar:</p>
      <pre>Manifest-Version: 1.0
Built-By: locke
Class-Path: lib/joda-time-2.9.6.jar
Created-By: Apache Maven 3.3.9
Build-Jdk: 1.8.0_60
Main-Class: cttd.maven.Main</pre>
      <p><strong>Cách 3: Tạo 1 file jar cho gọn (Uber jar)<br>
        </strong></p>
      <p>Sử dụng Maven Assembly Plugin</p>
      <p>Thêm plugin vào file pom (ở mục build/plugins):</p>
      <pre><code class="xml">&lt;!-- Maven Assembly Plugin --&gt;
&lt;plugin&gt;
	&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
	&lt;version&gt;3.0.0&lt;/version&gt;
	
	&lt;configuration&gt;
		&lt;!-- Get all project dependencies --&gt;
		&lt;descriptorRefs&gt;
			&lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;
		&lt;/descriptorRefs&gt;
		
		&lt;!-- MainClass in mainfest make a executable jar --&gt;
		&lt;archive&gt;
			&lt;manifest&gt;
				&lt;mainClass&gt;cttd.maven.Main&lt;/mainClass&gt;
			&lt;/manifest&gt;
		&lt;/archive&gt;
	&lt;/configuration&gt;
	
	&lt;executions&gt;
		&lt;execution&gt;
			&lt;id&gt;make-assembly&lt;/id&gt;
			&lt;!-- bind to the packaging phase --&gt;
			&lt;phase&gt;package&lt;/phase&gt;
			&lt;goals&gt;
				&lt;goal&gt;single&lt;/goal&gt;
			&lt;/goals&gt;
		&lt;/execution&gt;
	&lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
      <p>Plugin trên đã được gắn vào bước package nên để đóng gói thì bạn chỉ
        cần đánh lệnh maven package bình thường.</p>
      <p>Có 2 file jar ở thư mục package:</p>
      <ul>
        <li>build-jar.jar – Chỉ chứa các class của dự án của bạn</li>
        <li>build-jar-jar-with-dependencies.jar - Đây là cái bạn muốn</li>
      </ul>
      Chạy file:
      <p><code>java -jar target/build-jar-jar-with-dependencies.jar</code></p>
      <p>Sử dụng Mave Shade Plugin (tốt hơn Maven Assembly Plugin theo Mkyong)</p>
      <p>Thêm plugin vào file pom:</p>
      <pre><code class="xml">&lt;!-- Maven Shade Plugin --&gt;
&lt;!-- https://mvnrepository.com/artifact/org.apache.maven.plugins/maven-shade-plugin --&gt;
&lt;plugin&gt;
	&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
	&lt;version&gt;2.4.3&lt;/version&gt;
	
	&lt;executions&gt;
		&lt;!-- Run shade goal on package phase --&gt;
		&lt;execution&gt;
			&lt;phase&gt;package&lt;/phase&gt;
			&lt;goals&gt;
				&lt;goal&gt;shade&lt;/goal&gt;
			&lt;/goals&gt;
			&lt;configuration&gt;
				&lt;transformers&gt;
					&lt;!-- Add Main-Class to manifest file --&gt;
					&lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;
						&lt;mainClass&gt;cttd.maven.Main&lt;/mainClass&gt;
					&lt;/transformer&gt;
				&lt;/transformers&gt;
			&lt;/configuration&gt;
		&lt;/execution&gt;
	&lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
      <p>Package bình thường. P.S The generated dependency-reduced-pom.xml is
        for reference only, just ignore it.</p>
      <p>Trong thư mục target có 2 file jar:</p>
      <ul>
        <li>build-jar - Đây là file bạn muốn</li>
        <li>original-build-jar</li>
      </ul>
      <p>Chạy file:</p>
      <p><code>java -jar target/build-jar.jar</code></p>
      <h3>Thực hiện với Eclipse</h3>
      <p>Làm thế nào để package với Eclipse</p>
      <p>Maven build ...</p>
      <p>Đánh vào clean package</p>
      <p>Lần sau thì chọn Maven build thôi.</p>
      <h3>Tham khảo</h3>
      <p>http://mvnrepository.com/</p>
    </article>
    <script src="../../js/docs.js"></script>
  </body>
</html>
