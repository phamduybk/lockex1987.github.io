<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Docker Compose</title>
  </head>
  <body>
    <p>Theo như định nghĩa trên trang chủ thì nó là một công cụ dùng để quản lý
      các contianer cũng như liên kết các image đó với nhau. Tham khảo tại đây <a
        href="https://docs.docker.com/compose/">https://docs.docker.com/compose/</a>.</p>
    <p>Còn theo giải thích mì ăn liền của tôi là như thế này:</p>
    <p>Khi bạn chạy một ứng dụng web WordPress bạn cần hệ điều hành đó là Linux
      cụ thể là Ubuntu, cơ sở dữ liệu là MySQL, ngôn ngử lập trình là PHP cuối
      cùng là máy chủ web Nginx hoặc Apache.</p>
    <p>Chúng ta có thể đóng gói các thành phần đó lại với nhau gọi là LEMP hoặc
      LAMP vào một image rồi sau đó dùng nó để chạy WordPress thông qua dòng
      lệnh sau:</p>
    <pre>docker run --name some-wordpress --link some-mysql:mysql -d wordpress</pre>
    <p>hoặc:</p>
    <pre>docker run --name some-wordpress --link mysqlwp:mysql -p 80:80 \
    -e WORDPRESS_DB_NAME=wordpress \
    -e WORDPRESS_DB_USER=wordpress \
    -e WORDPRESS_DB_PASSWORD=wordpresspwd \
    -d wordpress</pre>
    <p>Nhưng bạn đã phạm phải một nguyên tắc căn bản trong Docker đó là mỗi một
      image trong Docker chỉ làm một công việc duy nhất đó chính là tính năng cơ
      bản trong micro-service mà Docker áp dụng vào, do đó thay vì dùng câu lệnh
      trên chúng ta có thể chạy câu lệnh thế này.</p>
    <pre><code>docker run --name nginx -p 80:80 -d nginx</code>
<code>docker run --name php-fpm -p 9000:9000 -d gsviec/php</code>
<code>docker run --name mysql -p 3600:3060 \</code>
<code>    MYSQL_ROOT_PASSWORD=secret \</code>
    <code></code><code>MYSQL_DATABASE=phanbook \</code>
    <code></code><code>MYSQL_USER=phanbook \</code>
    <code></code><code>MYSQL_PASSWORD=secret \</code>
    <code></code><code>-d mysql</code></pre>
    <p>Nhưng thế này thì mỗi lần deploy hay chạy lại thêm các tham số cấu hình
      rất là phức tạp do đó thằng Docker Compose nó được sinh ra giúp cho việc
      quản lý dễ dàng hơn.</p>
    <p>Nói tóm lại công dụng của Docker Compose giúp cho việc quản lý và phát
      triển một dự án thông qua Docker nhanh hơn và trực quan hơn.</p>
    <h3>Các dùng</h3>
    <p>Như mọi khi dùng WordPress để demo là cách tốt nhất cho các bạn muốn học
      Docker.</p>
    <p>Để dùng Docker Compose thì bạn chỉ việc tạo một tập tin có tên là <code>docker-compose.yaml</code>
      cú pháp nó theo định dạng YAML, nếu bạn chưa biết YAML là gì thì có thể
      xem qua bài viết <a href="http://symfony.com/doc/current/components/yaml/yaml_format.html">YAML
        Format</a>.</p>
    <p>Tập tin docker-composer.yml có nội dung như sau:</p>
    <pre>version: '2'
 
services:
    mysql:
        image: mysql
        restart: always
        environment:
           - variables.env
        # volumes:
        #     - ./data/mysql:/docker-entrypoint-initdb.d
    nginx:
        depends_on:
            - phpfpm
        image: nginx
        ports:
            - "80:80"
        restart: always
        working_dir: /var/www
        volumes:
            - ./wordpress:/var/www/
            - ./conf/nginx/gsviec.conf:/etc/nginx/conf.d/default.conf
        links:
            - phpfpm
     
    phpfpm:
        image: phalconphp/php-apache:ubuntu-16.04
        restart: always
        working_dir: /var/www
        ports:
            - "8080:80"
        volumes:
            - ./wordpress:/var/www
        depends_on:
            - mysql
    download: 
 
        image: nginx
        restart: 'no'
        volumes:
            - ./:/var/www
        command: sh download-wp.sh</pre>
    <p>Hãy để tôi giải thích vài tham số cho bạn hiểu.</p>
    <p>Dòng đầu tiên chỉ là định nghĩa <code>version</code> của Docker compose
      thôi hiện tại nó đã có phiên bản là 3 nhưng tôi vẫn thích dùng 2.</p>
    <p>Dưới dòng <code>services</code> tôi định nghĩa các image cần thiết để
      chạy WordPress bao gồm nginx, mysql, php-fpm khi bạn chạy lệnh <code>docker-compose
        up</code> nó sẽ tạo các container tương ứng từ các image mà bạn định
      nghĩa.</p>
    <p>Còn tập tin <code>variables.env</code> là các tham số cấu hình MySQL bạn
      có thể thay đổi nó nếu bạn muốn, sau này bạn muốn thêm cấu hình thì chỉ
      việc thêm vào thôi, rất tiện lợi để quản lý do với cách gõ trực tiếp từ
      bash shell như ở trên, chẳng hạn sau này bạn muốn thêm một dịch vụ
      phpmyadmin để quản lý MySQL thì chỉ cần đoạn code này vào tập tin <code>docker-compose.yml</code>
      dưới chỗ services:</p>
    <pre>phpmyadmin:
    restart: always
    image: phpmyadmin/phpmyadmin:4.6
    depends_on:
      - mysql
    ports:
      - "9080:80"
    env_file:
      - variables.env</pre>
    <p>Còn trong tập tin <code>variables.env</code> bạn có thể thêm vào thông
      số cấu hình PHPmyadmin như sau:</p>
    <pre># phpMyAdmin settings
PMA_ARBITRARY=1
PMA_HOST=mysql
PMA_PORT=3306
PMA_USER=phalcon
PMA_PASSWORD=secret</pre>
    <p>Còn dòng code:</p>
    <pre>ports:
    - "8080:80"</pre>
    <p>có nghĩa là tôi cho web server apache lắng nghe ở cổng 8080, nếu bạn muốn
      lắng nghe ở cổng 80 thì chỉ việc thay đổi lại thành như sau:</p>
    <p>Kế đến bạn chạy lệnh bên dưới này để pull(kéo) 4 cái image định nghĩa bên
      trên rồi nó sẽ tự khởi tạo 3 cái container sau vài phút bạn chờ đợi.</p>
    <pre>docker-compose up -d</pre>
    <p>Trong 4 cái image tôi định nghĩa ở trên có 1 cái là restart: ‘no’ nên nó
      không khởi động, do đó khi bạn chạy lệnh:</p>
    <pre>docker ps</pre>
    <p>bạn chỉ thấy kết quả như thế này thôi:</p>
    <p><img src="https://i2.wp.com/gsviec.com/blog/blog/blog/wp-content/uploads/2017/04/Screenshot-at-Apr-05-20-52-45.png?w=1280&amp;ssl=1"
        data-recalc-dims="1"></p>
    <p>Cuối cùng bạn sau khi nó chạy xong kết quả sẽ có dạng như thế này nếu như
      bạn truy cập vào đường dẫn http://you-ip:port trong trường hợp của tôi là
      http://localhost.</p>
    <p><img src="https://i2.wp.com/gsviec.com/blog/blog/blog/wp-content/uploads/2017/04/Screenshot-at-Apr-05-20-55-04.png?w=1280&amp;ssl=1"
        data-recalc-dims="1"></p>
    <p>Chú ý mặc định docker compose nó sẽ lấy tên thư mục làm tên project cho
      bạn như hình trên nó là khoahocdockercanban, nếu bạn muốn thây đổi nó thì
      bạn thêm tham số -p.</p>
    <p>Ngoài ra nếu bạn muốn restart và stop nó thì dùng lệnh sau:</p>
    <pre>docker-compose restart<br>docker-compose stop</pre>
                                          
                                            
                                              
                                              <p>Tất nhiên bạn cũng có thể chạy
                                                lệnh docker-compose help để thấy
                                                các dòng lệnh nó hỗ trợ dưới đây
                                                là một kết quả trên máy tôi</p><pre>Commands:
  build              Build or rebuild services
  bundle             Generate a Docker bundle from the Compose file
  config             Validate and view the compose file
  create             Create services
  down               Stop and remove containers, networks, images, and volumes
  events             Receive real time events from containers
  exec               Execute a command in a running container
  help               Get help on a command
  kill               Kill containers
  logs               View output from containers
  pause              Pause services
  port               Print the public port for a port binding
  ps                 List containers
  pull               Pull service images
  push               Push service images
  restart            Restart services
  rm                 Remove stopped containers
  run                Run a one-off command
  scale              Set number of containers for a service
  start              Start services
  stop               Stop services
  top                Display the running processes
  unpause            Unpause services
  up                 Create and start containers
  version            Show the Docker-Compose version information</pre>
                                              
                                                
                                                  
                                                  <h3>Kêt luận</h3>
                                                  <p>Trên đây tôi đã hướng dẫn
                                                    bạn cách sử dụng Docker
                                                    Compose và cũng như cách cài
                                                    đặt WordPress thông qua
                                                    Docker Compose.</p>
                                                  <p>------</p><p><img src="https://viblo.asia/uploads/5ba6eabc-db92-41c5-b8b7-71b40b2e7a8b.jpg"></p><p>Compose là công cụ giúp định nghĩa và khởi chạy multi-container Docker applications. Trong Compose, chúng ta sử dụng Compose file để cấu hình application’s services. Chỉ với một câu lệnh, lập trình viên có thể dễ dàng create và start toàn bộ các services phục vụ cho việc chạy ứng dụng.</p><p>Compose là một công cụ tuyệt với không chỉ dùng cho development, testing, staging environments, mà còn ứng dụng trong CI workflows. Việc sử dụng Docker Compose được tóm lược trong 3 bước cơ bản sau:</p><ul><li>Khai báo app’s environment với Dockerfile.</li><li>Khai báo các services cần thiết để chạy app trong docker-compose.yml.</li><li>Run docker-compose up và Compose sẽ start và run app.</li></ul><p>Dưới đây là một ví dụ về file <code>docker-compose.yml</code>:</p><pre><code>version: '2'
services:
  web:
    build: .
    ports:
    - "5000:5000"
    volumes:
    - .:/code
    - logvolume01:/var/log
    links:
    - redis
  redis:
    image: redis
volumes:
  logvolume01: {}
</code></pre><p>Trong bài viết này chúng ta sẽ thử xây dựng một ứng dụng web Python chạy trên Docker Compose. Ứng dụng này sử dụng Flask framework và lưu trữ hit counter trên Redis. Demo này tương đối dễ hiểu và giúp người đọc làm quen nhanh chóng với Docker compose.</p><p>Trước khi bắt tay vào thử hãy đảm bảo bạn đã cài đặt cả Docker Engine &amp; Docker Compose trên máy tính.</p><h3>Step 1: Setup</h3><h4>1. Tạo thư mục cho project</h4><pre>$ mkdir composetest
$ cd composetest
</pre><h4>2. Tạo file app.py trong thư mục project với nội dung sau</h4><pre><code>from flask import Flask
from redis import Redis

app = Flask(__name__)
redis = Redis(host='redis', port=6379)

@app.route('/')
def hello():
    count = redis.incr('hits')
    return 'Hello World! I have been seen {} times.\n'.format(count)

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)
</code></pre><h4>3. Tạo 1 file requirements.txt trong project directory với nội dung sau</h4><pre><code>flask
redis
</code></pre><p>Khai báo các application’s dependencies.</p><h3>Step 2: Tạo Dockerfile</h3><p>Trong bước này chúng ta tiến hành viết Dockerfile để build ra Docker image. Image này chứa toàn bộ các dependencies mà app Python require, bao gồm cả chính Python.</p><p>Trong thư mục project, tạo file name: Dockerfile và paste nội dung sau vào:</p><pre><code>FROM python:3.4-alpine
ADD . /code
WORKDIR /code
RUN pip install -r requirements.txt
CMD ["python", "app.py"]
</code></pre><p>Chúng ta có thể hiểu đơn giản thành các bước sau:</p><ul><li>Build một image từ image Python 3.4 có sẵn trên Docker hub.</li><li>Thêm thư mục hiện tại . vào thư mục /code bên trong image.</li><li>Thiết lập thư mục làm việc với Docker thành /code.</li><li>Install các Python dependencies.</li><li>Set default command của container là <code>python app.py</code></li></ul><h3>Step 3: Khai báo các services bên trong Compose file</h3><p>Create một file tên là <code>docker-compose.yml</code> trong thư mục project với nội dung sau:</p><pre><code>version: '2'
services:
  web:
    build: .
    ports:
     - "5000:5000"
    volumes:
     - .:/code
  redis:
    image: "redis:alpine"
</code></pre><p>Compose file khai báo 2 services, web &amp; redis:</p><ul><li>Sử dụng image được build từ Dockerfile trong thư mục project.</li><li>Forwards the exposed port 5000 của container sang port 5000 trên host machine.</li><li>Mount thư mục project trên host sang /code bên trong container, cho phép bạn chỉnh sửa code mà ko cần rebuild image.</li></ul><p>Redis service thì sử dụng public Redis image trên Docker Hub registry.</p><h3>Step 4: Build và run ứng dụng với Compose</h3><h4>1. Start ứng dụng từ thư mục project</h4><pre><code>$ docker-compose up
 Pulling image redis...
 Building web...
 Starting composetest_redis_1...
 Starting composetest_web_1...
 redis_1 | [8] 02 Jan 18:43:35.576 # Server started, Redis version 2.8.3
 web_1   |  * Running on http://0.0.0.0:5000/
 web_1   |  * Restarting with stat
</code></pre><p>Compose kéo Redis image về host và tiến hành build một image cho code, sau đó start services bạn đã khai báo.</p><h4>2. Vào địa chỉ <a
href="http://0.0.0.0:5000/" target="_blank">http://0.0.0.0:5000/</a> trên trình duyệt sẽ thấy ứng dụng đang chạy</h4><p>Nếu bạn sử dụng Docker trên Linux, bạn cũng có thể thử vào bằng đường dẫn sau: <a
href="http://localhost:5000/" target="_blank">http://localhost:5000</a>.</p><p>Nếu bạn sử dụng Docker Machine trên Mac, hãy dùng lệnh <code>docker-machine ip MACHINE_VM</code> để lấy IP address của Docker host. Sau đó vào bằng đường dẫn sau: http://MACHINE_VM_IP:5000</p><p>Bạn sẽ thấy message sau trên trình duyệt:</p><pre><code>Hello World! I have been seen 1 times.
</code></pre><h4>3. Refresh lại web page</h4><p>Số lượng view sẽ tăng lên.</p><h3>Step 5: Update the application</h3><p>Như đã đề cập trong step 3, application code đã được mount vào trong container <code>volume</code>, chính vì thế lập trình viên có thể chỉnh sửa code và thấy sự thay đổi này diễn ra tức thì mà không cần rebuild the image.</p><h4>1. Sửa code file <a
href="http://app.py/" target="_blank">app.py</a> và save lại</h4><pre><code>return 'Hello from Docker! I have been seen {} times.\n'.format(count)
</code></pre><h4>2. Refresh lại page và mọi thứ đã được cập nhật (dance2)</h4><h3>Step 6: Một vài câu lệnh thông dụng trong Docker compose</h3><p>Nếu bạn muộn khởi chạy các services bên trong background, hãy thêm flag <code>-d</code> (for “detached” mode) vào lệnh <code>docker-compose up</code> và sử dụng lệnh <code>docker-compose ps</code> để thẩy những gì đang chạy trên host:</p><pre><code>$ docker-compose up -d
Starting composetest_redis_1...
Starting composetest_web_1...

$ docker-compose ps
Name                 Command            State       Ports
-------------------------------------------------------------------
composetest_redis_1   /usr/local/bin/run         Up
composetest_web_1     /bin/sh -c python app.py   Up      5000-&gt;5000/tcp
</code></pre><p>Câu lệnh <code>docker-compose run</code> cho phép ta chạy 1 lần nhiều câu lệnh cho các services. Ví dụ để thấy các environment variables trên web service:</p><pre><code>$ docker-compose run web env
</code></pre><p>Dùng <code>docker-compose --help</code> để xem các câu lệnh có sẵn khác.</p><p>Nếu bạn started Compose với <code>docker-compose up -d</code> bạn có thể sẽ cần stop các services, khi đó hãy dùng lệnh:</p><pre><code>$ docker-compose stop
</code></pre><p>Bạn có thể xóa tất cả các container. Truyền vào --volumes để remove data volume được dùng bởi Redis container:</p><pre><code>$ docker-compose down --volumes
</code></pre><p>Tới đây, chắc hẳn là việc sử dụng Docker compose đã quá dễ dàng rồi (yaoming)</p><p><br></p><p>Bài viết thực hành với Django</p><p>https://viblo.asia/p/su-dung-docker-va-ca-docker-compose-cho-du-an-django-AQrMJbWNM40E</p><p>https://manhhomienbienthuy.bitbucket.io/2016/Apr/10/using-docker-and-docker-compose-for-django-development.html</p><p><br></p>
                                                  
                                                  <p><br>
                                                  </p>
                                                  <p><br>
                                                  </p>
                                                  
                                                
                                              
                                            
                                          
                                        
                                      
                                    
                                  
                                
                              
                            
                          
                        
                      
                    
                  
                
            
          
      
    
  

</body></html>