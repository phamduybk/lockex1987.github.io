<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Laravel Container">
    <meta name="keywords" content="docker, laravel">
    <meta name="author" content="lockex1987">
    <title>Docker Compose Laravel</title>
    <link rel="icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../css/style.css">
  </head>
  <body>
    <article>
      <h2> Tạo project Laravel với Docker</h2>
      <p> Tham khảo tại:</p>
      <ol>
        <li> Thiết lập môi trường Laravel + Docker cho môi trường development và
          production: <a href="https://medium.com/@shakyShane/laravel-docker-part-1-setup-for-development-e3daaefaf3c">
https://medium.com/@shakyShane/laravel-docker-part-1-setup-for-development-e3daaefaf3c</a></li>
      </ol>
      <p> Môi trường cài đặt </p>
      <ul>
        <li> docker: Docker version 17.06.0-ce, build 02c1d87 </li>
        <li> docker-compose: docker-compose version 1.15.0, build e12f3b9 </li>
        <li> docker-machine: docker-machine version 0.12.1, build c8b17e8 </li>
        <li>
          <p> OS : Ubuntu </p>
          <p> <code> Distributor ID: Ubuntu <br>
              Description: Ubuntu 16.04.2 LTS <br>
              Release: 16.04 <br>
              Codename: xenial </code> </p>
        </li>
      </ul>
      <p> Môi trường Laravel mục tiêu: </p>
      <ul>
        <li> Webserver: nginx 1.0 </li>
        <li> Database: MySQL 5.6 </li>
        <li> PHP: 7.0.4-FPM </li>
      </ul>
      <h3> Bước 1: Tạo project Laravel </h3>
      <p> cd tới nơi ta muốn đặt project rồi download archive của Laravel. </p>
      <p> <code> curl -L
          https://github.com/laravel/laravel/archive/v5.4.30.tar.gz | tar xz </code>
      </p>
      <p> Ta có thể tạo project bằng composer, nhưng như vậy sẽ yêu cầu máy cài
        thêm composer nữa. Composer sẽ cần thiết cho project, nhưng với ý nghĩa
        của việc dùng Docker, composer cũng như các library môi trường khác mình
        nghĩ nên cài đặt trên Docker chứ không phải trên máy chủ.</p>
      <p> Chúng ta sẽ cài đặt composer ở các bước sau. </p>
      <p> Download xong, chúng ta sẽ đổi tên thành tên project mà ta muốn, ở đây
        mình đổi thành <code>sample-laravel</code>:</p>
      <pre><code>mv laravel-5.4.30 sample-laravel</code></pre>
      <p>Và đặt con trỏ directory hiện tại vào đây:</p>
      <pre><code>cd sample-laravel</code></pre>
      <p> Đến đây ta đã có project thô của Laravel, để chạy được thì tiếp theo
        ta cần cài đặt các thư viện cho nó ở bước 2. </p>
      <h3> Bước 2: Cài đặt thư viện cho Laravel </h3>
      <p> Thông thường khi không dùng Docker, ta sẽ cần cài composer trên máy
        chủ và chạy <code> composer install </code> để tải bộ thư viện cần
        thiết vào <code> vendor</code>. Với Docker ta cũng sẽ làm tương tự như
        vậy, nhưng composer không cần cài đặt trên máy chủ mà sẽ được đặt vào 1
        container trong Docker. Container này sẽ chạy <code> composer install </code>
        vào thư mục trên máy ảo mà ta sẽ mount nó với chính project hiện tại.</p>
      <p> <code> docker run --rm -v $(pwd):/app composer/composer install</code></p>
      <ul>
        <li> <code> docker run </code> : Khởi tạo và chạy 1 container. Tương
          đương với việc tạo mới (create) và chạy (start) nó ngay lập tức. </li>
        <li> <code> --rm </code> : Thông thường khi 1 container chạy xong và
          kết thúc. Hệ thống file cũng như volume tương ứng mà nó tạo ra sẽ còn
          được lưu lại (để dễ debug chăng). Với option <code> --rm </code> ,
          hệ thống file cũng như volume mà nó tạo ra sẽ được xóa khi container
          kết thúc (nhưng image thì không). Với ý định chỉ install các lib cần
          thiết, mình nghĩ option này là phù hợp. </li>
        <li> <code> -v $(pwd):/app </code> : mount thư mục hiện tại vào thư
          mục <code> /app </code> trong container, là nơi composer mong muốn
          sẽ tìm thấy <code> composer.json </code> . </li>
      </ul>
      <p> Note: Thực tế khi mình chạy lệnh này, mình có thêm <code> sudo </code>
        vì mình thấy có vấn đề về mount, và có lỗi không tìm thấy <code>
          composer.json </code> nếu không dùng. </p>
      <p> Khi lệnh chạy hoàn tất, ta sẽ thấy folder <code> vendor </code> xuất
        hiện trong thư mục hiện tại. Như vậy các thư viện cần thiết cho Laravel
        đã được tải xong. Tiếp theo ta sẽ cài đặt môi trường webserver, database
        cho project với docker-compose. </p>
      <h3> Bước 3: Cài đặt môi trường Docker với docker-compose </h3>
      <p> Ta sẽ tạo 4 file cài đặt sau đây: </p>
      <ol>
        <li> <code> docker-compose.yml</code>: cài đặt các service chạy trong
          Docker, mỗi service sẽ đảm nhiệm 1 chức năng như service về webserver,
          service về database. </li>
        <li> <code> app.dockerfile</code>: đặc tả cài đặt cho service app được
          định nghĩa trong compose ở trên. </li>
        <li> <code> web.dockerfile</code>: đặc tả cài đặt cho service web được
          định nghĩa trong compose ở trên (ta sẽ đặt tên theo format
          .dockerfile). </li>
        <li> <code> vhost.conf</code>: file cấu hình cho webservice nginx. </li>
      </ol>
      <h4> 3.1. Cài đặt cho service app - PHP-FPM: </h4>
      <p> Ta sẽ viết đoạn cài đặt sau vào <code> docker-compose.yml </code> :
      </p>
      <pre>version: '3'
services:

  # The Application
  app:
    build:
      context: ./
      dockerfile: app.dockerfile
    working_dir: /var/www
    volumes:
      - ./:/var/www/
</pre>
      <p> Ý nghĩa : </p>
      <ul>
        <li> <code> version 3</code>: version của docker-compose, ở đây mình
          chọn là 3 </li>
        <li> <code> context</code>: thư mục đặt dockerfile </li>
        <li> <code> dockerfile</code>: đặc tả cài đặt về service sẽ dùng image
          nào, trong container trạng thái sẽ có những thư mục nào được cài sẵn.</li>
        <li> <code> working_dir</code>: tương tự như đặc tả của <code> docker
            run</code>, thư mục được chọn trong container để chạy các file
          binaries. Mặc định là <code> root</code>.</li>
        <li> <code> volumes</code>: mount thư mục hiện tại <code>./</code>
          (chứa source code) trên máy host vào <code> /var/www </code> trên
          container. Điều này cho phép chúng ta thay đổi source code khi
          container đang chạy runtime.</li>
      </ul>
      <p> <code> app.dockerfile</code>: Ta sẽ viết các lib cần thiết cho việc
        chạy code PHP vào đây.</p>
      <pre><code>FROM php:7.0.4-fpm

RUN apt-get update &amp;&amp; apt-get install -y libmcrypt-dev \
    mysql-client libmagickwand-dev --no-install-recommends \
    &amp;&amp; pecl install imagick \
    &amp;&amp; docker-php-ext-enable imagick \
    &amp;&amp; docker-php-ext-install mcrypt pdo_mysql
</code></pre>
      <h4> 3.2. Cài đặt cho service web - NGINX </h4>
      <p> Ta sẽ cần 1 webservice để xử lý các request đến và đưa đến cho Laravel
        xử lý. Ngoài nginx ta có thể chọn apache. Mình cũng không biết nhiều về
        2 loại webserver này nhưng mình nghe nói nginx dễ học hơn nên chọn
        nginx.</p>
      <h5> <code> docker-compose.yml</code> : chỉ định cài đặt service web </h5>
      <pre><code>  # The Web Server
  web:
    build:
      context: ./
      dockerfile: web.dockerfile
    working_dir: /var/www
    ports:
      - 8080:80
</code></pre>
      <ul>
        <li> <code> ports: - 8080:80</code>: Ánh xạ cổng 8080 trên máy ảo vào
          cổng 80 trên container. Note: trong docker-compose version 2, option <code>
            volumes_from </code> có được sử dụng để trỏ volume giữa các
          services nhưng đến docker-compose 3 đã bị remove đi. Nên mình dùng
          option <code> volume </code> thay vào đó.</li>
      </ul>
      <h5> <code> web.dockerfile</code> : cài đặt cụ thể cho nginx </h5>
      <pre><code>FROM nginx:1.10
ADD vhost.conf /etc/nginx/conf.d/default.conf
</code></pre>
      <h5> <code> vhost.conf</code> : cấu hình cho nginx</h5>
      <pre>server {
      listen 80;
      index index.php index.html;
      root /var/www/public;

      location / {
          try_files $uri /index.php?$args;
      }

      location ~ \.php$ {
          fastcgi_split_path_info ^(.+\.php)(/.+)$;
          fastcgi_pass app:9000;
          fastcgi_index index.php;
          include fastcgi_params;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          fastcgi_param PATH_INFO $fastcgi_path_info;
          sendfile off;
      }
}
</pre>
      <h4> 3.3. Cài đặt cho service database - MySQL </h4>
      <h5> <code> docker-compose.yml </code> </h5>
      <pre><code>  # The Database
  database:
    image: mysql:5.6
    volumes:
      - dbdata:/var/lib/mysql
    environment:
      - "MYSQL_DATABASE=homestead"
      - "MYSQL_USER=homestead"
      - "MYSQL_PASSWORD=secret"
      - "MYSQL_ROOT_PASSWORD=secret"
    ports:
        - "33061:3306"

volumes:
  dbdata:
</code></pre>
      <p> Ý nghĩa : </p>
      <ul>
        <li> <code> image: mysql:5.6 </code> So sánh với các service ở trên
          đều có 1 dockerfile đặc tả cài đặt cho nó thì service database này chỉ
          cần pull image mysql về là đủ. Các đặc tả cần thiết khác đều có sẵn
          trong image này nên ta sẽ không cần viết riêng. </li>
        <li> <code> dbdata:/var/lib/mysql</code>: dbdata là volume được chọn để
          lưu data sql (là 1 volume riêng trong container, không phải mount với
          folder trong laravel như service app). Với ý nghĩa là volume mà các
          service khác sẽ cần dùng đến, ta sẽ cần định nghĩa nó riêng ở ngoài ở
          dòng cuối <code> volumes: dbdata </code> . </li>
        <li> <code> enviroment</code>: Các biến môi trường. Với định nghĩa như
          ở trên, mysql sẽ tạo cho chúng ta 1 database và 1 user như vậy. (Nếu
          không đặc tả thì sẽ chỉ có 1 user root và database mặc định của MySQL)</li>
      </ul>
      <h3> docker-compose.yml tổng hợp</h3>
      <p> Như vậy đến đây ta sẽ đặc tả xong các file cần thiết cho
        docker-compose, ta sẽ có file <code> docker-compose.yml </code> như
        sau:</p>
      <pre>version: '3'

services:

  # The Application
  app:
    build:
      context: ./
      dockerfile: app.dockerfile
    working_dir: /var/www
    volumes:
      - ./:/var/www/

  # The Web Server
  web:
    build:
      context: ./
      dockerfile: web.dockerfile
    working_dir: /var/www
    ports:
      - 8080:80

  # The Database
  database:
    image: mysql:5.6
    volumes:
      - dbdata:/var/lib/mysql
    environment:
      - "MYSQL_DATABASE=homestead"
      - "MYSQL_USER=homestead"
      - "MYSQL_PASSWORD=secret"
      - "MYSQL_ROOT_PASSWORD=secret"
    ports:
        - "33061:3306"

volumes:
  dbdata:
</pre>
      <p> Như vậy việc đặc tả các file cài đặt đã hoàn tất. Tiếp theo trước khi
        đến khi chạy thử, ta sẽ khởi tạo 1 số dữ liệu cũng như key cho cần thiết
        cho Laravel. </p>
      <h3> Chaỵ các service </h3>
      <p> Ta sẽ chạy các services trên bằng command sau:</p>
      <pre>docker-compose up
</pre>
      <p>Ta có thể chọn option -d (detach) để tiến trình ẩn vào background khi
        hoàn tất.</p>
      <p> Lần đầu chạy, command sẽ cần khoảng vài phút để pull về các image cần
        thiết. Nhưng lần thứ 2 trở đi nếu các chỉ định images không thay đổi thì
        thời gian chạy sẽ nhanh hơn nhiều do không phải tải lại các image nữa.</p>
      <p> Đến đây ta sẽ cần chuẩn bị 1 số thiết lập cho Laravel để project có
        thể sẵn sàng chạy được.</p>
      <h3> Thiết lập cho Laravel </h3>
      <h4> File enviroment : <code> .env </code> </h4>
      <p> <code> cp .env-example .env </code> </p>
      <h4> Generate key và optimze command : </h4>
      <pre><code>docker-compose exec app php artisan key:generate
docker-compose exec app php artisan cache:clear
</code></pre>
      <p> (Nếu bị lỗi không tìm thấy file <code> .env </code> thì hãy thử chạy
        với sudo) </p>
      <p> <code> docker-compose exec &lt;service-name&gt; &lt;câu lệnh&gt; </code>
        : với câu lệnh ở trên, ta thấy ý nghĩa sẽ là chạy <code> &lt;câu
          lệnh&gt; </code> bên trong container của service <code>
          &lt;service-name&gt; </code> </p>
      <p> Option:<code><br>
        </code></p>
      <p><code>docker-compose exec app php artisan migrate --seed</code></p>
      <p>Migrate database. Nếu chạy không lỗi với "migrate successful" ta có thể
        yên tâm rằng kết nối giữa app với database là ok.</p>
      <p>Note : nếu command trả về lỗi không tìm thấy file hoặc khi <code>
          docker-compose exec app ls -la </code> nhận thấy các folder không
        được mount đúng cách, cấu trúc folder trong container không giống với ở
        thư mục host, có thể các bạn cần lệnh <code> sudo </code> ở <code>
          docker-compose run </code> ở trên.</p>
      <p>Đến đây app đã sẵn sàng được sử dụng với đường dẫn: <a href="http://0.0.0.0:8080/">
          http://0.0.0.0:8080 </a> </p>
      <p> <a href="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/rs95z8xkoq_Screenshot%20from%202017-08-07%2001-34-37.png">
        </a> </p>
      <a href="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/rs95z8xkoq_Screenshot%20from%202017-08-07%2001-34-37.png">
        <img src="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/rs95z8xkoq_Screenshot%20from%202017-08-07%2001-34-37.png">
      </a> <a href="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/rs95z8xkoq_Screenshot%20from%202017-08-07%2001-34-37.png">
      </a> <a> </a>
      <p> </p>
      <h2> Tổng kết</h2>
      <p> Đến đây mình nghĩ đã hoàn thành setup cho môi trường phát triển.</p>
      <p> GIt repo: <a href="https://github.com/mytv1/sample-docker-laravel">
          https://github.com/mytv1/sample-docker-laravel </a> </p>
      <p> Hi vọng ở bài viết tới mình có thể viết về cài đặt cho môi trường
        production.</p>
      <p> https://kipalog.com/posts/Thu-cai-dat-moi-truong-docker-cho-laravel</p>
      <p>
        https://kipalog.com/posts/Deploy-Laravel-voi-Docker-len-moi-truong-Production</p>
      <p>
        https://hungtut.com/2018/07/30/cai-dat-moi-truong-dev-laravel-su-dung-docker/</p>
      <p> </p>
    </article>
    <script src="../../js/docs.js"></script>
  </body>
</html>
