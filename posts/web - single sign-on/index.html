<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Single Sign-on</title>
  </head>
  <body>
    <h2 itemprop="headline">Xác thực Single Sign On là gì và nó hoạt động như
      thế nào?</h2>
    <p></p>
    <p> </p>
    <h3>Single Sign On (SSO) là gì?</h3>
    <p>Một cách đơn giản Single Sign On nghĩa là khi người dùng đăng nhập vào
      một hệ thống, họ sẽ đăng nhập vào tất cả các hệ thống khác liên quan.</p>
    <p>Một ví dụ điển hình cho việc ứng dụng thuật ngữ này là Google, Google sử
      dụng cho những sản phẩm của họ như: Gmail, YouTube, Google Maps... Điều
      này được thực hiển bởi một "dịch vụ trung tâm" (trong trường hợp Google là
      https://accounts.google.com).</p>
    <p>Ngược lại, Single Sign Off là thuật ngữ mà theo đó khi người dùng đăng
      xuất khỏi hệ thống sẽ chấm dứt quyền truy cập vào các hệ thống còn lại.</p>
    <p>Single Sign On là một kỹ thuật rất hay, áp dụng khi ta muốn tập trung hóa
      việc đăng nhập, quản lý các hệ thống lớn hoặc đơn giản là xác minh để lấy
      API.</p>
    <p>Lợi ích của nó thì rất rõ ràng: giảm thiểu rủi ro cho việc truy cập đến
      trang web của bên thứ ba, giảm thời gian cho người dùng khi phải đăng nhập
      nhiều lần.</p>
    <p>Xác thực Single Sign On (SSO) ngày càng trở nên cần thiết hơn bao giờ
      hết. Ngày nay, hầu hết các trang web đều yêu cầu xác thực để truy cập tới
      các tính năng và nội dung của nó. Với số lượng các trang web và dịch vụ
      đang tăng lên, một hệ thống đăng nhập tập trung (centralized login system)
      trở nên cần thiết. Trong 2 phần của loạt bài này chúng ta sẽ tìm hiểu cách
      xác thực SSO (SSO authentication) được triển khai cho các ứng dụng và ví
      dụ sử dụng OpenID Connect (trong phần 2).</p>
    <h3>Các thuật ngữ</h3>
    <p>Khái niệm xác thực tập trung hay liên kết danh tính điện tử được biết đến
      như là federated identity (liên kết danh tính). Các hệ thống federated
      identity xử lý các vấn đề:</p>
    <p> </p>
    <ul>
      <li>Xác thực (authentication)</li>
      <li>Phân quyền (authorization)</li>
      <li>Trao đổi thông tin người dùng</li>
      <li>Quản lý người dùng</li>
    </ul>
    <h3>Xác thực Single Sign On (SSO)</h3>
    <p>Sớm hay muộn thì các team phát triển web cũng sẽ phải đối mặt với một vấn
      đề: bạn đã phát triển một ứng dụng tại domain X và bây giờ bạn muốn phát
      triển một ứng dụng mới tại domain Y sử dụng các thông tin đăng nhập giống
      với domain X. Trong thực tế, bạn muốn nhiều hơn thế: nếu người dùng đã
      đăng nhập vào domain X họ cũng sẽ tự động đăng nhập vào domain Y. Đây là
      cái SSO giải quyết.</p>
    <p> </p>
    <p><img src="https://cdn.auth0.com/blog/sso/non-sso-scenario.png"></p>
    <p> </p>
    <p>Giải pháp cho kịch bản ở trên là chia sẻ thông tin session giữa các
      domain. Tuy nhiên, vì lý do bảo mật, trình duyệt buộc phải tuân theo chính
      sách same origin policy. Nội dung của chính sách này là chỉ những người
      tạo ra mới có quyền truy cập các cookie (hay bất kỳ dữ liệu lưu trữ cục bộ
      nào). Nói cách khác, domain X không thể truy cập các cookie từ domain Y và
      ngược lại. Đây chính là vấn đề mà SSO giải quyết: chia sẻ thông tin
      session trên nhiều domain khác nhau.</p>
    <p> </p>
    <p><img src="https://cdn.auth0.com/blog/sso/same-origin-policy-forbids-this.png"></p>
    <p> </p>
    <p>Các giao thức SSO chia sẻ thông tin session theo nhiều cách khác nhau,
      nhưng những thứ cơ bản thì giống nhau đó là: có một central domain (domain
      trung tâm) để thực hiện xác thực (authentication) và sau đó session được
      chia sẻ với các domain khác theo nhiều cách. Ví dụ, center domain có thể
      tạo một JSON Web Token đã được ký (được mã hóa sử dụng JWE). Token này có
      thể được truyền tới client và được sử dụng để xác thực người dùng cho
      domain hiện tại cũng như bất kỳ domain nào khác. Token có thể truyền tới
      domain gốc bằng cách điều hướng và chứa tất cả các thông tin cần thiết để
      xác minh người dùng cho domain đang yêu cầu xác thực. Khi token đã được
      ký, thì nó không thể bị chỉnh sửa bởi bất kỳ client nào.</p>
    <p> </p>
    <p><img src="https://cdn.auth0.com/blog/sso/using-central-auth-domain.png"></p>
    <p> </p>
    <p>Bất cứ khi nào người dùng tới một domain yêu cầu phải xác thực, anh ta
      hay cô ta sẽ được chuyển đến domain xác thực (authentication domain). Nếu
      người dùng đã đăng nhập tại domain xác thực, anh ta hay cô ta sẽ ngay lập
      tức được chuyển hướng trở lại domain gốc với token để xác thực các request
      tiếp theo.</p>
    <p> </p>
    <p><img src="https://cdn.auth0.com/blog/sso/typical-sso-v2.png"></p>
    <h3>Luồng chạy chính của hệ thống sử dụng SSO</h3>
    <p>Khi bạn đăng nhập lần đầu tiên, cookie được khởi tạo ở "dịch vụ trung
      tâm", sau đó khi bạn truy cập vào hệ thống thứ hai thì trình duyệt sẽ
      chuyển hướng tới trung tâm nhưng bạn đã có cookie khi đăng nhập từ trước
      nên điều đó có nghĩa là bạn đã đăng nhập thành công vào các hệ thống còn
      lại.</p>
    <ul>
      <li>Client redirect người dùng tới Provider cho việc xác minh</li>
      <li>Người dùng đăng nhập vào Provider</li>
      <li>Provider redirect người dùng trở lại Client với một <code>token</code>
        được sinh ra ngẫu nhiên</li>
      <li>Client sử dụng <code>token</code> đó để tạo lời gọi API tới Provider
        cùng với ID và Secret Key tạo nên <code>Access Token</code></li>
      <li>Những request sau được xác minh thông qua <code>Access Token</code></li>
      <li>Đăng xuất xóa bỏ session ở Client cũng như Provider và database</li>
    </ul>
    <p></p>
    <h3>Các giao thức khác nhau</h3>
    <p>Nếu bạn đã đọc về SSO online, chắc chắn bạn sẽ biết rằng có rất nhiều
      cách để triển khai SSO như: OpenID Connect, Facebook Connect. SAML,
      Microsoft Account (trước kia là Passport),… Lời khuyên của chúng tôi là
      chọn bất kỳ cái nào mà bạn cảm thấy đơn giản và dễ dàng nhất để thực hiện.
      Ví dụ, SAML tập trung sâu vào các doanh nghiệp, vì thế trong một số trường
      hợp nó là lựa chọn hợp lý nhất. Nếu bạn cần kết hợp nhiều hơn một giải
      pháp, đừng lo lắng: có nhiều framewok cho phép kết hợp nhiều giải pháp SSO
      khác nhau. Một trong số các framework đó là AuthO.</p>
    <h3>Kết luận</h3>
    <p>Các hệ thống phân tán (decentralized system) ngày càng trở lên phổ biến
      và xác thực là một khía cạnh quan trọng của tất cả chúng. SSO giải quyết
      một vấn đề lớn: làm thế nào để quản được số lượng người dùng đang tăng lên
      trên toàn bộ hệ thống gồm nhiều ứng dụng và dịch vụ. Các framework chẳng
      hạn như OpenID Connect và các dịch vụ chẳng hạn như Auth0 làm cho việc
      tích hợp Single Sign On vào các ứng dụng mới hoặc đã có của bạn trở nên dễ
      dàng hơn nhiều. Nếu bạn đang triển khai xác thực trên một ứng dụng hay
      dịch vụ mới hãy xem xét tích hợp SSO.</p>
    <p></p>
    <h3>Tham khảo</h3>
    <p>Linh bài viết gốc <a target="_blank" href="https://auth0.com/blog/what-is-and-how-does-single-sign-on-work/">https://auth0.com/blog/what-is-and-how-does-single-sign-on-work/</a></p>
    <p></p>
    <p>https://viblo.asia/p/introduction-to-oauth2-3OEqGjDpR9bL</p>
    <p>https://allaravel.com/laravel-tutorials/gioi-thieu-oauth2/</p>
    <p>http://antoanthongtin.vn/Detail.aspx?CatID=8ab90f49-a562-4157-a607-d2474bf129a9&amp;NewsID=1caffb79-e759-4855-91fc-76840dfc5424</p>
    <p>https://auth0.com/blog/what-is-and-how-does-single-sign-on-work/</p>
    <p>https://auth0.com/learn/how-to-implement-single-sign-on/</p>
    <p>https://auth0.com/blog/creating-your-first-laravel-app-and-adding-authentication/</p>
    <p>https://www.phparch.com/2017/08/single-sign-on-youre-probably-doing-it-wrong/</p>
    <p>https://apereo.github.io/cas/5.3.x/index.html</p>
    <p>https://github.com/apereo/cas</p>
    <p>https://github.com/apereo/java-cas-client</p>
    <p>https://github.com/apereo/phpCAS</p>
    <p>---------------------------------------------------------------</p>
    <p>Chúng ta sẽ thử trên 2 app: passport và consumer.</p>
    <p>Ứng dụng consumer là ứng dụng tập trung vào nghiệp vụ của chúng ta. Việc
      xác thực được thực hiện qua passport.</p>
    <p>Ứng dụng passport cần có 3 chức năng sau:</p>
    <ul>
      <li>Đăng nhập.</li>
      <ul>
        <li>https://10.60.7.126:8665/passportv3/login?appCode=ESS&amp;service=http%3A%2F%2Fthongtinnhansu.viettel.vn%2FTTNS</li>
      </ul>
      <li>Đổi password sau khi đăng nhập. Có thể đổi thêm avatar.</li>
      <ul>
        <li>https://10.60.7.126:8665/passportv3/changePassword</li>
      </ul>
      <li>Quên mật khẩu.</li>
      <ul>
        <li>https://10.60.7.126:8665/passportv3/resetPassword</li>
      </ul>
    </ul>
    <p>Ngoài ra có thể thêm app vsa-admin để quản lý người dùng: thêm, sửa, xóa,
      đổi password do admin thực hiện.</p>
    <h3>Ứng dụng consumer<br>
    </h3>
    <p>Thêm các chức năng đăng nhập cho consumer:</p>
    <pre>$ php artisan make:auth</pre>
    <p>Trang consumer khi truy cập phát thì vào trang home luôn. Nếu chưa đăng
      nhập thì vào trang login.</p>
    <p>Sửa file <code>routes/web.php</code>.</p>
    <pre>Route::get('/', 'HomeController@index');<br>Route::get('/home', 'HomeController@index')-&gt;name('home');</pre><p>Xóa file <code>resources/views/welcome.blade.php</code>.<br>
    </p>
    <p>Bỏ các đường dẫn như đăng ký, reset mật khẩu.</p>
    <pre>$ php artisan route:list

+--------+----------+------------------------+------------------+------------------------------------------------------------------------+--------------+
|        | GET|HEAD | /                      |                  | Closure                                                                | web          |
|        | GET|HEAD | api/user               |                  | Closure                                                                | api,auth:api |
|        | GET|HEAD | auth/passport          |                  | Closure                                                                | web          |
|        | GET|HEAD | callback               |                  | Closure                                                                | web          |
|        | GET|HEAD | home                   | home             | App\Http\Controllers\HomeController@index                              | web,auth     |
|        | GET|HEAD | login                  | login            | App\Http\Controllers\Auth\LoginController@showLoginForm                | web,guest    |
|        | POST     | login                  |                  | App\Http\Controllers\Auth\LoginController@login                        | web,guest    |
|        | POST     | logout                 | logout           | App\Http\Controllers\Auth\LoginController@logout                       | web          |
|        | POST     | password/email         | password.email   | App\Http\Controllers\Auth\ForgotPasswordController@sendResetLinkEmail  | web,guest    |
|        | GET|HEAD | password/reset         | password.request | App\Http\Controllers\Auth\ForgotPasswordController@showLinkRequestForm | web,guest    |
|        | POST     | password/reset         | password.update  | App\Http\Controllers\Auth\ResetPasswordController@reset                | web,guest    |
|        | GET|HEAD | password/reset/{token} | password.reset   | App\Http\Controllers\Auth\ResetPasswordController@showResetForm        | web,guest    |
|        | GET|HEAD | register               | register         | App\Http\Controllers\Auth\RegisterController@showRegistrationForm      | web,guest    |
|        | POST     | register               |                  | App\Http\Controllers\Auth\RegisterController@register                  | web,guest    |
+--------+----------+------------------------+------------------+------------------------------------------------------------------------+--------------+</pre>
    <p>Sửa file <code>routes/web.php</code> như sau:</p><pre>Auth::routes(['register' =&gt; false, 'reset' =&gt; false]);</pre><p>Vào trang đăng nhập thì redirect đến trang passport.dev/login.</p><p>Sửa file routes/web.php như sau:</p><pre>Route::get('/login', function() {
    $passport_login = 'http://passport.dev/login';
    return redirect($passport_login);
})-&gt;name('login');</pre><p>Chú ý đoạn trên phải ở sau đoạn:</p><pre>Auth::routes(['register' =&gt; false, 'reset' =&gt; false]);</pre><p>Khi đăng xuất consumer thì cũng đăng xuất passport.</p>
    <p>Sửa link đăng xuất của consumer thành:</p><p><br></p><p><br></p><p><br></p><h3>Ứng dụng passport</h3>
    <p>Chúng ta cũng dựa vào đăng nhập mặc định của Laravel.</p><pre>$ php artisan make:auth</pre><p>Nhưng chúng ta sẽ không có đăng ký (vẫn có reset password), do đó chúng ta khai báo như sau ở <code>routes/web.php</code>:</p><pre>//Auth::routes();

Route::get('login', 'Auth\LoginController@showLoginForm')-&gt;name('login');
Route::post('login', 'Auth\LoginController@login');
Route::post('logout', 'Auth\LoginController@logout')-&gt;name('logout');

Route::get('password/reset', 'Auth\ForgotPasswordController@showLinkRequestForm')-&gt;name('password.request');
Route::post('password/email', 'Auth\ForgotPasswordController@sendResetLinkEmail')-&gt;name('password.email');
Route::get('password/reset/{token}', 'Auth\ResetPasswordController@showResetForm')-&gt;name('password.reset');
Route::post('password/reset', 'Auth\ResetPasswordController@reset')-&gt;name('password.update');</pre><p>Chúng ta thêm bảng sso_app như sau:</p><pre>CREATE TABLE sso_app (
    id INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(191),
    secret VARCHAR(100),
    redirect TEXT,
    PRIMARY KEY (id)
)
COLLATE='utf8_unicode_ci'
ENGINE=InnoDB
AUTO_INCREMENT=1;</pre><p>Bây giờ bắt đầu chỉnh sửa</p><p>Dùng Redis:</p><pre>$ composer require predis/predis</pre><p>Nếu người dùng đã đăng nhập hoặc đăng nhập thành công thì forward về trang của consumer.dev.</p><p>Nếu người dùng chưa đăng nhập thì hiển thị trang đăng nhập.</p><p><br></p><p><br></p><p><br></p><p><br></p><p><br>
    </p>
  

</body></html>