<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Block với nginx</title>
  </head>
  <body>
    <p>Block</p>
    <p><br>
    </p>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Khi
      sử dụng Nginx, bạn có thể dễ dàng block request GET / POST bất kỳ dựa theo
      User Agent.</p>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;"><a
        href="https://hocvps.com/wp-content/uploads/2016/05/gun.jpg" data-featherlight="image"
        style="box-sizing: border-box; text-decoration: none; outline: 0px; transition-duration: 0.12s; transition-timing-function: ease-out; color: rgb(217, 91, 68);"><img
          class="aligncenter wp-image-1810" src="https://hocvps.com/wp-content/uploads/2016/05/gun-665x442.jpg"
          alt="gun" style="box-sizing: border-box; border: 0px; display: block; margin-left: auto; margin-right: auto; max-width: 100%; height: auto; cursor: zoom-in;"
          height="332" width="500"></a></p>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Mình
      tìm hiểu phương pháp này khi website thường xuyên bị spam mail với nhiều
      IP khác nhau, tuy nhiên điểm chung là header của chúng giống hệt nhau.
      Nginx block rất hiệu quả.</p>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Ngoài
      ra, bạn có thể ứng dụng để block Bot, Spider, chống crawl…</p>
    <h2 style="box-sizing: border-box; font-size: 26px; margin: 36px 0px 24px; font-weight: 600; color: rgb(51, 51, 51); line-height: 32px; font-family: Arial, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Hướng
      dẫn block User Agent với Nginx</h2>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Mở
      file cấu hình tên miền (nếu dùng<span>&nbsp;</span><a href="https://hocvps.com/script/"
        style="box-sizing: border-box; text-decoration: none; outline: 0px; transition-duration: 0.12s; transition-timing-function: ease-out; color: rgb(217, 91, 68);">HocVPS
        Script</a><span>&nbsp;</span>file cấu hình ở đường dẫn<span>&nbsp;</span><code
style="box-sizing: border-box; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; display: inline-block; line-height: 22px; word-break: break-all; word-wrap: break-word; padding: 0px 4px; color: rgb(199, 37, 78); border-radius: 3px; background-color: rgb(249, 242, 244); border: 1px solid rgb(225, 225, 232); white-space: pre-wrap; margin: 0px 0px 24px;">/etc/nginx/conf.d/</code>),
      trong section server, hãy thêm đoạn code<span>&nbsp;</span><code style="box-sizing: border-box; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; display: inline-block; line-height: 22px; word-break: break-all; word-wrap: break-word; padding: 0px 4px; color: rgb(199, 37, 78); border-radius: 3px; background-color: rgb(249, 242, 244); border: 1px solid rgb(225, 225, 232); white-space: pre-wrap; margin: 0px 0px 24px;">if</code><span>&nbsp;</span>sau:</p>
    <pre style="box-sizing: border-box; margin: 0px 0px 24px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; display: block; line-height: 16px; word-break: break-all; background: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.15); padding: 7.5px; color: rgb(56, 56, 56); border-radius: 4px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">server {
    listen       80 default_server;

    root         /home/hocvps.com/public_html;
    index index.php index.html index.htm;
    server_name hocvps.com;

    <b style="box-sizing: border-box; font-weight: bold;"># case sensitive matching
    if ($http_user_agent ~ (Antivirx|Arian)) {
        return 403;
    }</b>

    <b style="box-sizing: border-box; font-weight: bold;"># case insensitive matching
    if ($http_user_agent ~* (netcrawl|npbot|malicious)) {
        return 403;
    }</b>

    ....
}</pre>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Sau
      đó nhớ restart lại Nginx.</p>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Tùy
      bạn lựa chọn:</p>
    <ul style="box-sizing: border-box; margin: 0px 0px 24px 48px; padding: 0px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">
      <li style="box-sizing: border-box; padding-left: 6px; margin-bottom: 12px;"><em
          style="box-sizing: border-box;">case sensitive matching</em>: phân
        biệt chữ in hoa, chữ in thường</li>
      <li style="box-sizing: border-box; padding-left: 6px; margin-bottom: 12px;"><em
          style="box-sizing: border-box;">case insensitive matching</em>: không
        phân biệt in hoa, in thường</li>
    </ul>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Để
      tìm được header cần filter, tất nhiên bạn sẽ phải phân tích file
      access.log trước.</p>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Để
      test kết quả bạn có thể dùng lệnh<span>&nbsp;</span><code style="box-sizing: border-box; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; display: inline-block; line-height: 22px; word-break: break-all; word-wrap: break-word; padding: 0px 4px; color: rgb(199, 37, 78); border-radius: 3px; background-color: rgb(249, 242, 244); border: 1px solid rgb(225, 225, 232); white-space: pre-wrap; margin: 0px 0px 24px;">wget</code><span>&nbsp;</span>kèm
      theo option&nbsp;<code style="box-sizing: border-box; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; display: inline-block; line-height: 22px; word-break: break-all; word-wrap: break-word; padding: 0px 4px; color: rgb(199, 37, 78); border-radius: 3px; background-color: rgb(249, 242, 244); border: 1px solid rgb(225, 225, 232); white-space: pre-wrap; margin: 0px 0px 24px;">--user-agent</code>,
      ví dụ:</p>
    <pre style="box-sizing: border-box; margin: 0px 0px 24px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; display: block; line-height: 16px; word-break: break-all; background: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.15); padding: 7.5px; color: rgb(56, 56, 56); border-radius: 4px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">wget --spider --user-agent "malicious bot" http://domain.com</pre>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Đây
      là đoạn code mình dùng để block request spam comment các bạn có &nbsp;thể
      tham khảo thêm:</p>
    <pre style="box-sizing: border-box; margin: 0px 0px 24px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; display: block; line-height: 16px; word-break: break-all; background: rgb(245, 245, 245); border: 1px solid rgba(0, 0, 0, 0.15); padding: 7.5px; color: rgb(56, 56, 56); border-radius: 4px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-style: initial; text-decoration-color: initial;">    #Block Spam comment
    location ~* /wp-comments-post\.php$ {
        if ($http_user_agent ~* "x11; linux i686; rv:17" ) {
            return 403;
        }
    }</pre>
    <p style="box-sizing: border-box; margin: 0px 0px 15px; color: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 15px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">Chúc
      bạn thành công.</p>
    <p></p>
    <p><br>
    </p>
    <p><br>
    </p>
    <p><br>
    </p>
    <p>https://hocvps.com/block-user-agent-nginx/</p>
    <p>https://hocvps.com/rule-nginx/</p>
    <p><br>
    </p>
  </body>
</html>
