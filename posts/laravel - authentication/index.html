<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Xác thực với Laravel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../css/style.css">
    <meta name="description" content="Đăng ký, đăng nhập, đăng xuất, quên mật khẩu">
  </head>
  <body>
    <article>
      <h2>Xác thực với Laravel</h2>
      <p>Xác thực (authentication) gồm các chức năng sau:</p>
      <ul>
        <li>Đăng ký</li>
        <li>Đăng nhập</li>
        <li>Gửi mail quên mật khẩu và reset mật khẩu</li>
        <li>Nhớ đăng nhập</li>
        <li>Trang chủ sau đăng nhập</li>
        <li>Đăng xuất</li>
      </ul>
      <p>Laravel hỗ trợ cơ bản các chức năng trên.</p>
      <p>Dùng lệnh:</p>
      <pre>php artisan make:auth</pre>
      <p>Các thay đổi là:</p>
      <pre>new file:   app/Http/Controllers/HomeController.php
new file:   resources/views/auth/login.blade.php
new file:   resources/views/auth/passwords/email.blade.php
new file:   resources/views/auth/passwords/reset.blade.php
new file:   resources/views/auth/register.blade.php
new file:   resources/views/home.blade.php
new file:   resources/views/layouts/app.blade.php
modified:   routes/web.php</pre>
      <p>Ngoài ra còn có các file cũ cũng được sử dụng khi authentication:</p>
      <pre>app/Http/Controllers/Auth/ForgotPasswordController.php<br>app/Http/Controllers/Auth/LoginController.php<br>app/Http/Controllers/Auth/RegisterController.php<br>app/Http/Controllers/Auth/ResetPasswordController.php</pre> 
   <p>File routes/web.php thêm như sau:</p> 
   <pre>Auth::routes();
Route::get('/home', 'HomeController@index')-&gt;name('home');</pre> 
   <p><code>Auth::routes()</code> nó làm cái gì? Nó gọi đến phương thức static <code>routes()</code> của class <code>Illuminate\Support\Facades\Auth</code>.</p> 
   <p>Chúng ta có thể tham khảo phương thức <code>auth()</code> của file <code>vendor/laravel/framework/src/Illuminate/Routing/Router.php</code> như sau:</p> 
   <pre>/**
 * Register the typical authentication routes for an application.
 *
 * @return void
 */
public function auth()
{
    // Authentication Routes...
    $this-&gt;get('login', 'Auth\LoginController@showLoginForm')-&gt;name('login');
    $this-&gt;post('login', 'Auth\LoginController@login');
    $this-&gt;post('logout', 'Auth\LoginController@logout')-&gt;name('logout');

    // Registration Routes...
    $this-&gt;get('register', 'Auth\RegisterController@showRegistrationForm')-&gt;name('register');
    $this-&gt;post('register', 'Auth\RegisterController@register');

    // Password Reset Routes...
    $this-&gt;get('password/reset', 'Auth\ForgotPasswordController@showLinkRequestForm')-&gt;name('password.request');
    $this-&gt;post('password/email', 'Auth\ForgotPasswordController@sendResetLinkEmail')-&gt;name('password.email');
    $this-&gt;get('password/reset/{token}', 'Auth\ResetPasswordController@showResetForm')-&gt;name('password.reset');
    $this-&gt;post('password/reset', 'Auth\ResetPasswordController@reset');
}</pre> 
   <p>Chúng ta tham khảo file <code>vendor/laravel/framework/src/Illuminate/Foundation/Auth/AuthenticatesUsers.php</code>.</p> 
   <pre>/**
 * Show the application's login form.
 *
 * @return \Illuminate\Http\Response
 */
public function showLoginForm()
{
    return view('auth.login');
}
</pre> 
   <p>HomeController.php</p> 
   <p><br></p> 
   <p>Nếu ứng dụng không có trang chủ hoặc landing page thì có thể chỉnh file <code>routes/web.php</code> như sau:</p> 
   <pre>Route::get('/', function () {
    // Nếu người dùng đã đăng nhập thì hiển thị trang home
    // nếu không thì hiển thị trang đăng nhập
    if (Auth::check()) {
        return view('home');
    } else {
        return view('auth.login');
    }
});</pre> 
   <p>Mặc định sẽ vào luôn trang home đã đăng nhập hoặc trang form đăng nhập.</p> 
   <p>Để làm một cách cơ bản, chúng ta cần thêm trang đổi mật khẩu.</p> 
   <p>Views</p> 
   <p>Để tương thích với các layout khác trong dự án, chúng ta có thể chuyển layouts/app.blade.php thành layout/authentication.blade.php. Sửa các file tương ứng ở thư mục auth cho extends đúng.</p> 
   <p><br></p> 
   <h3>Những chú ý về database</h3><p>Mặc định, Laravel thêm một App\User Eloquent model trong thư mục app. Model này có thể sử dụng với Eloquent authentication driver mặc định. Nếu ứng dụng của bạn không sử dụng Eloquent, bạn có thể dùng database authentication driver sử dụng Laravel query builder.</p><p>Khi xây dựng database schema cho model App\User model, đảm bảo rằng độ dài cột password tối thiểu là 60 kí tự. Mặc định với 255 kí tự sẽ là một lựa chọn tốt.</p><p>Ngoài ra, bạn cũng nên xác nhận table users (or equivalent) table chứa một nullable, cột&nbsp; remember_token chứa 100 characters. Cột này sẽ được dùng để lưu một token cho session "remember me" khi đang được duy trì bởi ứng dụng của bạn.</p> 
   <p>Đã có sẵn các file trong database/migrations.</p> 
   <p>Chúng ta chạy lệnh migrate</p> 
   <pre>php artisan migrate</pre> 
   <p>Có thể bị lỗi sau:</p> 
   <pre>SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes (SQL: alter table `users` add unique `users_email_unique`(`email`))</pre> 
   <p>https://laravel-news.com/laravel-5-4-key-too-long-error</p> 
   <p>Sửa file <code>AppServiceProvider.php</code> ở thư mục <code>app/Providers</code>, thêm dòng sau vào phương thức boot.</p> 
   <pre>use Illuminate\Support\Facades\Schema;

class AppServiceProvider extends ServiceProvider
{
    public function boot()
    {
        Schema::defaultStringLength(191);
    }
}</pre> 
   <p>Chú ý phải đúng là 191, không phải 255.</p> 
   <p>Các bảng sau sẽ được tạo:</p> 
   <p>users</p> 
   <pre>CREATE TABLE users (
    id INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(191) NOT NULL COLLATE 'utf8mb4_unicode_ci',
    email VARCHAR(191) NOT NULL COLLATE 'utf8mb4_unicode_ci',
    password VARCHAR(191) NOT NULL COLLATE 'utf8mb4_unicode_ci',
    remember_token VARCHAR(100) NULL DEFAULT NULL COLLATE 'utf8mb4_unicode_ci',
    created_at TIMESTAMP NULL DEFAULT NULL,
    updated_at TIMESTAMP NULL DEFAULT NULL,
    PRIMARY KEY (id),
    UNIQUE INDEX users_email_unique (email)
)</pre> 
   <p>Chú ý: độ dài các trường đang là 199.</p><h3>Thêm điều kiện được chỉ định</h3><p>Nếu muốn, bạn cũng có thể thêm những điều kiện mở rộng vào truy vấn xác thực. Ví dụ, chúng ta có thể xác nhận xem user đã được đánh dấu như "active":</p><pre>if (Auth::attempt(['email' =&gt; $email, 'password' =&gt; $password, 'active' =&gt; 1])) {
    // The user is active, not suspended, and exists.
}</pre> 
   <p>Lấy giá trị một trường nào đó của người dùng sau khi đăng nhập.</p> 
   <p>Get other field (is_admin)</p> 
   <p><br></p> 
   <h3>Tùy chỉnh đường dẫn</h3> 
   <p>Khi một người dùng xác thực thành công, họ sẽ được chuyển đến trang <code>/home</code>. Bạn có thể tùy chỉnh đường dẫn này bằng cách sửa thuộc tính <code>redirectTo</code> của các lớp <code>LoginController</code>, <code>RegisterController</code>, <code>ResetPasswordController</code>.</p> 
   <p>Tiếp theo, bạn sửa phương thức <code>handle</code> của lớp <code>RedirectIfAuthenticated</code>.</p><h3>Đăng xuất</h3><p>Để đăng xuất người dùng khỏi ứng dụng của bạn, bạn có thể sử dụng phương thức logout trong&nbsp; Auth facade. Việc này sẽ xóa toàn bộ thông tin xác thực trong session của user:</p><pre>Auth::logout();</pre><p><br></p><h3>Ghi nhớ người dùng</h3><p>Nếu bạn muốn cung cấp chức năng "remember me" ftrong ứng dụng, bạn có thể truyền một giá trị boolean như tham số thứ 2 vào phương thức attempt cái mà sẽ giữ cho người dùng đã được authentication vô thời hạn, hoặc tới khi họ đăng xuất thủ công. Tất nhiện, bảng users phải có một cột tring remember_token, cái mà sẽ được dùng để lưu "remember me" token.</p><pre>if (Auth::attempt(['email' =&gt; $email, 'password' =&gt; $password], $remember)) {
    // The user is being remembered...
}</pre><p>Nếu bạn sử dụng controller LoginController cung cấp bởi Laravel, tính năng "remember" đã được tích hợp bởi traits sử dụng trong controller.</p><p>Nếu bạn đang "remembering" người dùng, bạn có thể sử dụng phương thức viaRemember để xác định nếu người dung đã authentication sử dụng cookie "remember me":</p><pre>if (Auth::viaRemember()) {
    //
}</pre><p><br></p> 
   <p><br></p> 
   <h3>Tham khảo</h3><p>https://lockex1987.github.io/posts/laravel%20-%20login%20throttle/</p><p>https://lockex1987.github.io/posts/laravel%20-%20change%20users%20table%20name/</p><p>https://lockex1987.github.io/posts/laravel%20-%20login%20active%20user/</p><p>https://lockex1987.github.io/posts/laravel%20-%20email%20verification/</p><p>https://lockex1987.github.io/posts/laravel%20-%20change%20login%20field/</p><p>https://lockex1987.github.io/posts/laravel%20-%20add%20custom%20fields%20to%20register%20form/</p><p>https://lockex1987.github.io/posts/laravel%20-%20socialite/</p><p>https://lockex1987.github.io/posts/laravel%20-%20reset%20password/</p><p><a
href="https://lockex1987.github.io/posts/laravel%20-%20remember%20login/">https://lockex1987.github.io/posts/laravel%20-%20remember%20login/</a></p><p><a
href="https://giaphiep.com/docs/5.3/authentication">https://giaphiep.com/docs/5.3/authentication</a></p> 
   <p><a href="https://laravel.com/docs/master/authentication">https://laravel.com/docs/master/authentication</a></p> 
   <p><br></p> 
   <p><br></p> 
   <p><br></p> 
   <p><br></p> 
  </article> 
  <script src="../../js/docs.js"></script>
</body></html>